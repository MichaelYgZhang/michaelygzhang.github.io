---
layout: post
title: 亿级流量网站架构核心技术----读书笔记
excerpt: 亿级流量网站架构核心技术----读书笔记
category: Destributed
---


#### 第一部分 概述

- 高可用原则
  1. 降级
      - 开关集中化管理
      - 可降级的多级读服务
      - 开关前置化
      - 业务降级
  2. 限流
      - 恶意请求流量只访问到cache
      - 对于穿透到后端应用的流量可以考虑用Nginx的limit模块处理
      - 对于恶意IP可以使用nginx deny进行屏蔽
  3. 切流量
      - DNS切换机房入口
      - HttpDNS
      - LVS/HaProxy
      - Nginx
  4. 可回滚

- 业务设计原则
  1. 防重设计
  2. 幂等设计
  3. 流程可定义
  4. 状态与状态机，正向状态和逆向状态
  5. 后台系统操作可反馈
  6. 后台系统审批化
  7. 文档和注释
  8. 备份

#### 第2部分 高可用

- 负载均衡与反向代理   TODO 未看完，后期可以边看nginx源码边了解这里
  1. 负载均衡算法
    - 轮询默认
    - ip_hash
    - hash_key 一致性哈希
    - 哈希算法
  2. 失败重试机制
  3. 健康检查 nginx_upstream_check_module支持TCP心跳和HTTP心跳来实现健康检查

- 隔离之术
  1. 线程隔离
  2. 进程隔离--可以指不同的系统模块
  3. 集群隔离
  4. 机房隔离
  5. 读写隔离
  6. 动静隔离
  7. 爬虫隔离
  8. 热点隔离
  9. 资源隔离 读热点采用多级缓存，写热点采用缓存+队列模式消峰
  10. 使用Hystrix实现隔离

- 限流详解
  1. 限流算法，令牌桶，漏桶。计数器可以用来进行简单粗暴的限流
  2. 应用级限流 总并发，连接，请求数。限流某个接口的总并发数，或单位时间内的总请求数。Guava的Cache。RateLimiter。可以平滑限流
  3. 分布式限流 Redis+Lua ／ Nginx+Lua
  4. 接入层限流 ngx_http_limit_conn_module 可以按照ip或者指定的key进行限流，如果需要根据实际情况变化的key，速率，桶的大小动态的特征那么就需要OpenResty提供的Lua限流模块lua_resty_limit_traffic。
  5. 节流指的是在特定时间窗口内对重复的相同事件最多只处理一次，或者想限制多个连续相同事件最小执行时间间隔。ThrottleFirst,throttleLast,throttleWithTimeout

- 降级特技
  1. 降级功能点
    - 页面降级
    - 页面片段降级
    - 页面异步请求降级
    - 服务功能降级
    - 读降级
    - 写降级
    - 爬虫降级
    - 风控降级
  2. 自动开关降级
  3. 人工开关降级
  4. 读写服务降级
  5. 多级降级 页面JS-接入层-应用层  
  6. 配置中心  JDK7 WatchService实现文件变更监听
  7. Hystrix实现熔断 TODO

- 超时与重试机制
  1. 代理层超时与重试 Haproxy，Nginx，Twemproxy
    -
  2. Web容器超时 Tomcat，Jetty等
  3. 中间件客户端超时与重试 RPC，Dubbo，MQ，Httpclient等
  4. 数据库客户端 MySQL，Oracle等事务超时，获取连接池超时，SQL执行超时等
  5. NoSQL客户端超时
  6. 业务超时，执行超时，接口超时
  7. 前端Ajax超时
  8. 可以通过配置JVM参数  -Dsun.net.client.defaultConnectTimeout = 60000 来配置默认的全局Socket连接/读超时，即如果HttpCLient，JDBC等如果没有配置Socket超时，则使用该超时。

- 回滚机制
  1. 事务回滚，定期扫表，循环队列，补偿机制，本地记录事务，若JVM挂可以分析事务日志重新回滚
  2. 代码回滚

- 压测与预案
  1. 压测接口，并发量，压测策略（突发，逐步加压，并发量）压测指标（机器负载，QPS／TPS，响应时间）压测报告。根据报告分析结果系统优化和容灾
  2. 线下压测 Jmeter，Apache ab 压测系统某个接口，然后进行调优JVM参数优化代码等，以实现单个接口组件的性能最优
  3. 系统优化和容灾
  4. 应急预案

#### 第3部分 高并发

- 应用级缓存,堆缓存，堆外缓存，磁盘缓存，分布式缓存
  - Guava Cache, Ehcache , MapDB
  - Guava Cache：只提供堆缓存
  - Ehcache 提供堆缓存，堆外缓存，磁盘缓存，分布式缓存
  - MapDB 支持堆缓存，堆外缓存，磁盘缓存
- HTTP缓存   TODO
- 多级缓存  TODO
- 连接池线程池详解
  1. 数据库连接池C3P0, DBCP, Druid
  2. HttpClient连接池
  3. Java线程池
  4. Tomcat线程池配置

- 异步并发实战
- 如何扩容
  1. 单体机器扩容
  2. 业务拆分，服务化
  3. 数据库拆分
    - 分库分表策略
    1. 取模，简单，热点分散，按照非主键查询需要夸库夸表，扩容需要做数据迁移，可以先冗余足够数量的分库分表，还有问题可以先从升级硬件开始解决，硬盘，网卡，磁盘等。先双写主从，数据迁移，最后删除冗余，分库太多消耗数据库连接，应用会创建更多线程。这种情况用数据代理中间件会更好。
    2. 按时间分库，范围分区进行分库分表。缺点存在热点数据问题，易水平扩展，避免数据迁移。

- 队列术  
