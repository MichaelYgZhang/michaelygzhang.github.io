---
layout: post
title: HTTP权威指南-4
excerpt: 第四章－连接管理
category: CS
---

* TOC
{:toc}

#### TCP连接
- TCP的可靠数据管道
- TCP流是分段的、由IP分组传送。(TCP的数据是通过名为IP分组或者IP数据报的小数据块来发送的)

**HTTP与HTTPS**

HTTP | 应用层|
-----|------|
TCP|  传输层|
IP|网络层|
网络接口|数据链路层|

HTTP| 应用层|
----|------|
TSL or SSL|安全层|
TCP|传输层|
IP|网络层|
网络接口层|数据链路层|

- 保持TCP连接持续不断地运行(TCP通过端口号保持所有持续运行的TCP连接)，TCP连接通过4个值来识别`<源IP地址、源端口号、目的IP地址、目的端口号>`进而一起定义唯一的一条连接。
- 使用TCP套接字编程

套接字API调用 |描述|
------------|----|
s = socket(`<parameters>`)|创建一个新的、未命名、未关联的套接字|
bind(s,`<local IP:port>`)|向套接字赋一个本地端口号和接口|
connect(s, `<remote IP:port>`)|创建一条连接本地套接字与远程主机及端口的连接|
listen(s,....)|标识一个本地套接字，使其可以合法接受连接|
s2 = accept(s)|等待某人建立一条到本地端口的连接|
n = read(s, buffer, n)|尝试从套接字向缓冲区读取n个字节|
n = write(s, buffer, n)|尝试从缓冲区中向套接字写入n个字节|
close(s)|完全关闭TCP连接|
shutdown(s, `<side>`)|只关闭TCP连接的输入或输出端|
getsockopt(s,...)|读取某个内部套接字配置选项值|
setsockopt(s,...)|修改某个内部套接字配置选项值|

#### 对TCP性能的考虑
- HTTP事务的时延
> 1. 客户端首选需要根据URL确定Web服务器的IP地址和端口号，如果最近没有对URL中的主机名进行访问，通过DNS解析系统将URL中的主机名转换成一个IP地址可能需要花费数十秒的时间
> 2. 客户端会向服务器发送一条TCP连接请求，并等待服务器回送一个请求接受应答，每条新的TCP连接都会有连接时延，这个值通常最多只有一两秒钟，但如果数百个HTTP事务的话，这个值会快速地叠加上去。
> 3. 一旦连接建立起来了，客户端就会通过新建立的TCP管道来发送HTTP请求，数据到达时，Web服务器会从TCP连接中读取请求报文，并对请求进行处理，网络传输请求报文以及服务器处理请求报文都需要时间。
> 4. Web服务器会会送HTTP响应，这也需要花费时间。

总结:这些TCP网络时延的大小取决于硬件速度，网络和服务器的负载，请求和响应报文的尺寸，以及客户端和服务器之间的距离。TCP协议技术的复杂性也会对时延产生巨大对影响。
- 性能聚集区域
> 1. TCP连接建立握手
> 2. TCP慢启动拥塞控制
> 3. 数据聚集的Nagle算法
> 4. 用于捎带确认的TCP延迟确认算法
> 5. TIME_WAIT时延和端口耗尽

- TCP连接的握手时延(SYN/SYN+ACK三次握手)SYN是一种标记，表明是连接请求
- 延迟确认
- TCP慢启动‘自动调谐’
- Nagle算法与TCP_NODELAY(每个TCP段至少装载40个字节的标记和首部，如果TCP发送了大量包含少量数据的分组，网络性能就会严重下降，这种行为称为"发送端傻窗口综合症";Nagle算法就是试图在发送一个分组之前，将大量TCP数据绑定在一起，以提高效率。可以在栈中设置参数TCP_NODELAY来禁用Nagle算法，如果需要这么做一定要确保会向TCP写入大块的数据，这样就不会产生一堆小分组了)
- TIME_WAIT累积与端口耗尽

#### HTTP连接的处理
- 常被误解的Connection首部
> 1. HTTP首部字段名，列出了只与此链接有关的首部
> 2. 任意标签值，用于描述此连接的非标准选项
> 3. 值close，说明操作完成之后需关闭这条持久连接
> 4. ⚠️如果报文中包含连接相关的信息，不能将其转发出去，在转发之前，必须删除Connection首部列出的所有首部字段。进而可以防止无意中对本地首部的转发。被称为对首部的保护。

```js
HTTP/1.1 200 OK
Cache-control: max-age=3600
Connection: meter, close, bill-my-credit-card
Meter: max-users=3, max-refuses=6, dont-report
```

首部说明: 不应该转发Meter首部，要应用假象的bill-my-credit-card选项，且本次事务结束之后应关闭持久连接。

- 串行事务处理时延

四类提高HTTP的连接性能的方法
1. 并行连接(通过多条TCP连接发起并发的HTTP请求)
2. 持久连接(重用TCP连接，以消除连接及关闭时延)
3. 管道化连接(通过共享的TCP连接发起并发的HTTP请求)
4. 复用的连接(交替传送请求和响应报文)

#### 并行连接
- 并行连接可能会提高页面的加载速度
- 并行的连接不一定更快
- 并行连接可能让人“感觉”更快一些

#### 持久连接
- 在HTTP事务处理结束之后仍然保持在打开状态的TCP连接被称为持久连接。重用已对目标服务器打开的空闲持久连接，就可以避开缓慢的连接建立阶段，并且已经打开的连接还可以避免慢启动的拥塞适应阶段，以便更快速地进行数据的传输。
- 持久及并行连接，缺点:每个事务都会打开/关闭一条新的连接，会耗费时间和带宽，由于TCP慢启动特性的村子啊，每条新连接的性能都会有所降低，可打开的并行连接数量实际上是有限的。所以持久连接与并行连接配合使用是最高效的方式。
- HTTP/1.0 + keep-alive连接

```
Connection: Keep-Alive
Keep-Alive: max=5, timeout=120
```

响应报文表明服务器最多还会为另外5个事务保持连接的打开状态，或者将打开状态保持到连接空闲了2分钟之后。

⚠️HTTP/1.0中keep-alive并不是默认使用的，在需要保持持久连接的请求报文中添加请求首部Connection: Keep-Alive的请求首部来激活keep-alive本次TCP的持久连接。







[TCP-wiki](https://en.wikipedia.org/wiki/TCP)
