---
layout: post
title: 从Paxos到Zookeeper分布式一致性原理与实践
excerpt: PaxosToZookeeper
category: Destributed
---

##### 第1章 分布式架构

- 1-从集中式到分布式
- 分布式系统是一个硬件或软件组件分布在不同的网络计算机上，彼此之间仅仅通过消息传递进行通信和协调的系统。
- 分布式系统特性：`分布性`、`对等性`、`并发性`、`缺乏全局时钟`、`故障总是会发生`。
- 分布式环境中的问题：`通信异常`、`网络分区`、三态(`成功`、`失败`、`超时`)、`节点故障`
- 从ACID到CAP/BASE; Atomicity原子性、Consistency一致性、Isolation隔离性、Durability持久性；

- 标准SQL规范中定义了4个事务隔离级别：
  1. 未授权读取即读未提交允许出现脏读
  2. 授权读取即只允许读取已经被提交的数据
  3. 可重复读取即多次读取同一个数据时，其值和事务开始时刻是一致的，禁止了不可重复读和脏读，可能出现幻影数据
  4. 串行化即最严格事务隔离级别，事务串行执行。

- CAP和BASE理论：
  1. Consistency一致性、Availability可用性、Partition tolerance分区容错性。
  2. BASE：Basically Avaliable基本可用、Soft state软状态和Eventually consistent最终一致性的简写

- 最终一致性存在以下5种变种
  1. 因果一致性
  2. 读已之所写
  3. 会话一致性
  4. 单调读一致性
  5. 单调写一致性

##### 第2章 一致性协议

- 2PC与3PC
  - 2PC: 
 
 ```js
  1. 提交事务请求(投票阶段)
    1. 事务询问
    2. 执行事务,各参与者节点执行事务操作并将Undo和Redo信息记入事务日志中
    3. 各参与者向协调者反馈事务询问的响应
  
  2. 执行事提交(根据阶段一的反馈情况决定最终是否可以进行事务提交操作)
    1. 执行事务(阶段一都返回Yes响应)
      1. 发送提交请求，协调者向所有参与者发出Commit请求
      2. 事务提交，参与者接收到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放整个事务执行期间占用的事务资源。
      3. 反馈事务结果,参与者在事务完成后向协调者发送Ack消息
      4. 完成事务，协调者接收到所有参与者反馈的Ack消息后，完成事务。
    2. 中断事务，任何一个参与者向协调者反馈了No响应或者等待超时后，协调者无法接收到所有参与者的反馈响应，就中断事务
      1. 发送回滚请求，协调者向所有参与者发出Rollback请求
      2. 事务回滚，参与者接收到Rollback请求后，会利用阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放整个事务执行期间占用的资源
      3. 反馈事务回滚结果，参与者完成事务回滚后向协调者发送Ack消息
      4. 中断事务，协调者接收到所有参与者反馈的Ack消息，完成事务中断。
```

- 优缺点:优点，`原理简单`、`实现方便`。缺点:`同步阻塞`、`单点问题`、`数据不一致`比如commit阶段一部分成功一部分网络问题无法提交产生数据不一致、`太过保守容错机制差`。

- 3PC: 将2PC协议的第二个阶段过程一分为二，形成由`CanCommit`、`PreCommit`和`do Commit`三个阶段组成的事务处理协议。

```js    
    1. CanCommit
      1. 事务询问
      2. 各参与者向协调者反馈事务询问的响应
    
    2. PreCommit
      1. 执行事务预提交(所有参与者反馈Yes)
	1. 发送预提交请求
	2. 事务预提交
	3. 各参与者向协调者反馈事务执行的响应
      2. 中断事务(所有参与者有任意一个反馈No，或者等待超时无法接收到参与者的反馈)
		1. 发送中断请求
		2. 中断事务，无论是来自协调者的abort请求还是出现等待超时参与者都中断事务
      
    3. doCommit
	1. 执行事务
	  1. 发送提交请求，参与者从预提交状态转到提交状态，并向所有参与者发送doCommit请求
	  2. 事务提交，提交事务并在之后释放事务执行期间占用的事务资源
	  3. 反馈事务提交结果，参与者向协调者发送Ack消息
	  4. 完成事务，协调者接收到所有参与者反馈的Ack消息后完成事务
	
	2. 中断事务
	  1. 发送中断请求
	  2. 事务回滚
	  3. 反馈事务回滚结果
	  4. 中断事务
```

- 一旦进入阶段三，可能存在以下问题
  1. 协调者出现问题
  2. 协调者和参与者之间的网络故障

- 无论出现那种情况，都导致参与者无法及时接收到来自协调者的doCommit或者abort请求，针对这种异常，参与者都会在等待超时后，继续进行事务提交。

- 三阶段优缺点：
  - 优点：相比二阶段降低参与者的阻塞范围，并能在出现单点故障后达成一致
  - 缺点：三阶段去除阻塞的同时引入了新的问题，就是在参与者接收到preCommit消息后如果网络出现分区，此时协调者所在的节点和参与者都无法正常网络通信，这种情况下，参与者依然会进行事务提交，必然导致数据的不一致性

- Paxos算法  莱斯利-兰伯特 LeslieLamport
  - “拜占庭将军问题”, 为解决这个问题提出了 Paxos理论。核心算法是一致性算法。
  - TODO Paxos

##### 第3章 Paxos的工程实践

- Google Chubby P52

##### 第4章 ZooKeeper与Paxos
##### 第5章 使用Zookeeper
##### 第6章 Zookeeper的典型应用场景
##### 第7章 Zookeeper技术内幕
##### 第8章 Zookeeper运维
