<!DOCTYPE html>
<html>
  <head>
    <title>Netty – Michael – Developer</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Netty" />
    <meta property="og:description" content="Netty" />
    
    <meta name="author" content="Michael" />

    
    <meta property="og:title" content="Netty" />
    <meta property="twitter:title" content="Netty" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Michael - Developer" href="/feed.xml" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"/>
  </head>

  <body>

    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/favicon.ico" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Michael</a></h1>
            <p class="site-description">Developer</p>
          </div>

          <nav>
            <a href="/"><i class="fa fa-home fa-2x"></i></a>
            <a href="/category"><i class="fa fa-tags fa-2x" aria-hidden="true"></i></a>
            <a href="/about"><i class="fa fa-user-secret fa-2x"></i></a>
            <a href="/blog"><i class="fa fa-university fa-2x"></i></a>
            <!-- <a href="/task"><i class="fa fa-book fa-2x" aria-hidden="true"></i></a> -->
            <a href="/feed.xml" target="_blank"><i class="fa fa-feed fa-2x"></i></a>

            <!-- 
            
              
            
              
            
              
              <a href="/" >
                Home
              </a>
              
            
              
              <a href="/blog" >
                Blog
              </a>
              
            
              
              <a href="/category" >
                Category
              </a>
              
             -->
          </nav>

          <a href="https://github.com/MichaelYgZhang" target="_blank">
            <img class="fork-me-on-github" src="/images/fork-me-on-github.png" alt="Fork me on GitHub">
          </a>
        </header>

        <div id="search-container">
          <input type="text" id="search-input" placeholder="search...">
          <ul id="results-container"></ul>
        </div>

      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <div class="post">
    <h1 class="post-title">Netty</h1>
    <span class="post-date">2017-02-09</span>
    <!--  |
    
     -->
    <article>
      <h4 id="netty高性能之道">Netty高性能之道</h4>

<ul>
  <li>传统RPC调用采用BIO即阻塞IO，线程模型问题：由于采用同步阻塞IO，会导致每个TCP连接都占用一个线程，由于线程资源是JVM虚拟机非常宝贵的资源，当IO读写阻塞导致无法及时释放时，会导致系统性能急剧下降，严重的甚至会导致虚拟机无法创建新的线程。</li>
  <li>高性能RPC三个主题
    <ol>
      <li>传输:用什么样的通道将数据传输给对方，BIO、NIO、AIO，IO模型很大程度上决定了框架的性能。</li>
      <li>协议：采用什么样的通信协议，HTTP或者内部私有自定义协议，协议的不同，性能也有不同。相比公有协议，内部私有协议的性能通常可以被设计的更优。</li>
      <li>线程:数据报如何读取，读取后编解码在那个线程进行，编解码后的消息如何派发，Reactor线程模型的不同，对性能影响也非常大。</li>
    </ol>
  </li>
  <li>零拷贝。
    <ol>
      <li>Netty的接收和发送ByteBuffer采用Direct Buffers，使用堆外直接内存进行Socket读写，不需要进行字节缓冲区的二次拷贝。如果使用传统的堆内存(Heap Buffers)进行Socket读写，JVM会将堆内存Buffer拷贝一份到直接内存中，然后才写入Socket中。相比堆外直接内存，消息在发送过程中多了一次缓冲区的内存拷贝。</li>
      <li>Netty提供了组合Buffer对象，可以聚合多个ByteBuffer对象，用户可以像操作一个Buffer那样方便的对组合Buffer进行操作，避免了传统通过内存拷贝的方式将几个小Buffer合并成一个大Buffer。</li>
      <li>Netty的文件传输采用了transferTo方法，它可以直接将文件缓冲区数据发送到目标Channel，避免了传统通过循环write方式导致的内存拷贝问题。</li>
    </ol>
  </li>
  <li>高效的Reactor线程模型: 有三种。
    <ol>
      <li>Reactor单线程模型</li>
      <li>Reactor多线程模型</li>
      <li>主从Reactor多线程模型.
        <ul>
          <li>Reactor单线程模型，指的是所有IO操作都在同一个NIO线程上面完成，NIO线程职责如下:</li>
        </ul>
        <ol>
          <li>作为NIO服务端，接受客户端的TCP连接。</li>
          <li>作为NIO客户端，向服务端发起TCP连接。</li>
          <li>读取通信对端的请求或者应答。</li>
          <li>向通信对端发送消息请求或者应答消息。
     - 单线程模型缺点:</li>
          <li>一个NIO线程同时处理成百上千的链路，性能上无法支撑，即便NIO线程的CPU负荷达到100%，也无法满足海量消息的编码、解码、读取和发送；</li>
          <li>当NIO线程负载过重之后，处理速度变慢，导致大量客户端连接超时，超时后往往会进行重发，这更加重了NIO线程的负载，最终导致大量消息积压和处理超时，NIO线程会成为系统的性能瓶颈。</li>
          <li>可靠性问题：一旦NIO线程意外跑飞，或者死循环，导致整个系统通信模块不可用，不能接收和处理外部消息，造成节点故障。
     - Reactor多线程模型：</li>
          <li>有专门一个NIO线程Acceptor线程用于监听服务端，接收客户端的TCP连接请求。</li>
          <li>网络IO操作读、写等由一个NIO线程池负责，线程池可以采用标准的JDK线程池实现，它包含一个任务队列和N个可用线程，由这些NIO线程负责消息的读取、解码、编码和发送。</li>
          <li>1个NIO线程可以同时处理N条链路，但是1个链路只对应1个NIO线程，防止并发操作问题。
     - 主从Reactor多线程模型：解决了1个服务端监听线程无法有效处理所有客户端连接的性能不足问题。
     - Netty的线程模型并非固定不变，通过在启动辅助类中创建不同的EventLoopGroup实例并通过适当的参数配置，就可以支持上述三种Reactor线程模型。正是因为Netty 对Reactor线程模型的支持提供了灵活的定制能力，所以可以满足不同业务场景的性能诉求。</li>
        </ol>
      </li>
    </ol>
  </li>
  <li>Netty无锁化的串行设计。</li>
  <li>高效的并发编程:主要体现在如下几点。
    <ol>
      <li>volatile的大量且正确使用。</li>
      <li>CAS和原子累的广泛使用。</li>
      <li>线程安全容器的使用。</li>
      <li>通过读写锁提升并发性能。</li>
    </ol>
  </li>
  <li>高性能的序列化框架:
    <ol>
      <li>序列化后的码流大小(网络带宽的占用)</li>
      <li>序列化&amp;反序列化的性能(CPU资源占用)</li>
      <li>是否支持跨语言(异构系统的对接口和开发语言的切换)
        <ul>
          <li>Netty默认提供了堆Google Protobuf的支持，通过扩展Netty的编解码接口，可以实现其他高性能序列化框架。由于Java原生的序列化性能太差才催生了各种高性能开源序列化技术和框架。以及跨语言、IDL定义等其他原因。</li>
        </ul>
      </li>
    </ol>
  </li>
  <li>Netty灵活的TCP参数配置能力，合理设置TCP参数在某些场景下对性能的提升可以起到显著地效果。</li>
</ul>

    </article>
  </div>

  <div class="related">
    <h4>最新文章</h4>
    <ul class="related-posts">
      
        <li>
          <h5>
            <a href="/books/2017/08/18/%E5%86%85%E5%90%91%E8%80%85%E4%BC%98%E5%8A%BF.html">
              内向者优势
              <small>2017-08-18</small>
            </a>
          </h5>
        </li>
      
        <li>
          <h5>
            <a href="/architecture/2017/08/10/%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF.html">
              亿级流量网站架构核心技术
              <small>2017-08-10</small>
            </a>
          </h5>
        </li>
      
        <li>
          <h5>
            <a href="/architecture/2017/07/26/%E9%87%8D%E6%9E%84%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1.html">
              重构-改善既有代码的设计
              <small>2017-07-26</small>
            </a>
          </h5>
        </li>
      
    </ul>
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'michaelygzhangblog';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:g.zhangyg@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/MichaelYgZhang"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/michaelygzhang"><i class="svg-icon twitter"></i></a>


<a href="https://plus.google.com/115646538142388831563"><i class="svg-icon googleplus"></i></a>

        </footer>
      </div>
    </div>

    <div id="backToTop" class="backtoTop">
    	<i class="fa fa-hand-o-up fa-2x"></i>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-84531968-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/java/2017/02/09/netty.html',
		  'title': 'Netty'
		});
	</script>
	<!-- End Google Analytics -->


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.1.5/jekyll-search.js" type="text/javascript"></script>
    <script src="/js/blog.js" type="text/javascript"></script>

    <script type="text/javascript">
          SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            json: '/search.json',
            searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
            noResultsText: 'No results found',
            limit: 10,
            fuzzy: false,
            exclude: ['Welcome']
          })
    </script>
  </body>
</html>
