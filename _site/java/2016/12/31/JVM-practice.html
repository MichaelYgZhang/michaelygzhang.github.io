<!DOCTYPE html>
<html>
  <head>
    <title>JVM Optimize Practice – Michael – Developer</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="JVM Optimize Practice" />
    <meta property="og:description" content="JVM Optimize Practice" />
    
    <meta name="author" content="Michael" />

    
    <meta property="og:title" content="JVM Optimize Practice" />
    <meta property="twitter:title" content="JVM Optimize Practice" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Michael - Developer" href="/feed.xml" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"/>
  </head>

  <body>

    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/favicon.ico" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Michael</a></h1>
            <p class="site-description">Developer</p>
          </div>

          <nav>
            <a href="/"><i class="fa fa-home fa-2x"></i></a>
            <a href="/category"><i class="fa fa-tags fa-2x" aria-hidden="true"></i></a>
            <a href="/about"><i class="fa fa-user-secret fa-2x"></i></a>
            <a href="/blog"><i class="fa fa-university fa-2x"></i></a>
            <!-- <a href="/task"><i class="fa fa-book fa-2x" aria-hidden="true"></i></a> -->
            <a href="/feed.xml" target="_blank"><i class="fa fa-feed fa-2x"></i></a>

            <!-- 
            
              
            
              
            
              
              <a href="/" >
                Home
              </a>
              
            
              
              <a href="/blog" >
                Blog
              </a>
              
            
              
              <a href="/category" >
                Category
              </a>
              
             -->
          </nav>

          <a href="https://github.com/MichaelYgZhang" target="_blank">
            <img class="fork-me-on-github" src="/images/fork-me-on-github.png" alt="Fork me on GitHub">
          </a>
        </header>

        <div id="search-container">
          <input type="text" id="search-input" placeholder="search...">
          <ul id="results-container"></ul>
        </div>

      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <div class="post">
    <h1 class="post-title">JVM Optimize Practice</h1>
    <span class="post-date">2016-12-31</span>
    <!--  |
    
     -->
    <article>
      <ul>
  <li>JVM堆内存的分代: 虚拟机的堆内存共划分为三个代：年轻代（Young Generation）、年老代（Old Generation）和持久代（Permanent Generation）。其中持久代主要存放的是Java类的类信息，与垃圾收集器要收集的Java对象关系不大。所以，年轻代和年老代的划分才是对垃圾 收集影响比较大的。</li>
  <li>年轻代: 所有新生成的对象首先都是放在年轻代的。年轻代的目标就是尽可能快速的收集掉那些生命周期短的对象。年轻代分三个区。一个Eden区，两个 Survivor区(一般而言)。大部分对象在Eden区中生成。当Eden区满时，还存活的对象将被复制到Survivor区（两个中的一个），当一个Survivor区满 时，此区的存活对象将被复制到另外一个Survivor区，当另一个Survivor区也满了的时候，从前一个Survivor区复制过来的并且此时还存 活的对象，将被复制“年老区”。需要注意，两个Survivor区是对称的，没先后关系，所以同一个Survivor区中可能同时存在从Eden区复制过来对象，和从另一个Survivor区复制过来的对象；而复制到年老区的只有从前一个Survivor区（相对的）过来的对象。而且，Survivor区总有一个是空的。特殊的情况下，根据程序需要，Survivor区是可以配置为多个的（多于两个），这样可以增加对象在年轻代中的存在时间，减少被放到年老代的可能。</li>
  <li>年老代: 在年轻代中经历了N（可配置-XX:MaxTenuringThreshold）次垃圾回收后仍然存活的对象，就会被放到年老代中。因此，可以认为年老代中存放的都是一些生命周期较长的对象。</li>
  <li>持久代: 用于存放静态数据，如 Java Class, Method 等。持久代对垃圾回收没有显著影响，但是有些应用可能动态生成或者调用一些Class，例如 Hibernate 等，在这种时候需要设置一个比较大的持久代空间来存放这些运行过程中动态增加的类型。持久代大小通过 -XX:MaxPermSize进行设置。</li>
</ul>

<h5 id="常用命令">常用命令</h5>

<h6 id="jpsjava-virtual-machine-process-status-tooljps主要用来输出jvm中运行的进程状态信息">jps(Java Virtual Machine Process Status Tool)jps主要用来输出JVM中运行的进程状态信息</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="nx">jps</span> <span class="p">[</span><span class="nx">options</span><span class="p">]</span> <span class="p">[</span><span class="nx">hostid</span><span class="p">]</span>
<span class="o">-</span><span class="nx">q</span> <span class="err">不输出类名、</span><span class="nx">Jar</span><span class="err">名和传入</span><span class="nx">main</span><span class="err">方法的参数</span>
<span class="o">-</span><span class="nx">m</span> <span class="err">输出传入</span><span class="nx">main</span><span class="err">方法的参数</span>
<span class="o">-</span><span class="nx">l</span> <span class="err">输出</span><span class="nx">main</span><span class="err">类或</span><span class="nx">Jar</span><span class="err">的全限名</span>
<span class="o">-</span><span class="nx">v</span> <span class="err">输出传入</span><span class="nx">JVM</span><span class="err">的参数</span>
</code></pre>
</div>

<h6 id="jstack--如果是在64位机器上需要指定选项-j-d64-输出-jvm自身线程用户线程等">jstack  如果是在64位机器上，需要指定选项”-J-d64”， 输出 jvm自身线程、用户线程等</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="nx">jstack</span> <span class="p">[</span> <span class="nx">option</span> <span class="p">]</span> <span class="nx">pid</span>
<span class="nx">jstack</span> <span class="p">[</span> <span class="nx">option</span> <span class="p">]</span> <span class="nx">executable</span> <span class="nx">core</span>
<span class="nx">jstack</span> <span class="p">[</span> <span class="nx">option</span> <span class="p">]</span> <span class="p">[</span><span class="nx">server</span><span class="o">-</span><span class="nx">id</span><span class="err">@</span><span class="p">]</span><span class="nx">remote</span><span class="o">-</span><span class="nx">hostname</span><span class="o">-</span><span class="nx">or</span><span class="o">-</span><span class="nx">IP</span>
<span class="o">-</span><span class="nx">F</span><span class="err">当</span><span class="nx">jstack</span> <span class="p">[</span><span class="o">-</span><span class="nx">l</span><span class="p">]</span> <span class="nx">pid</span><span class="err">没有相应的时候强制打印栈信息</span>
<span class="o">-</span><span class="nx">l</span> <span class="err">长列表</span><span class="p">.</span> <span class="err">打印关于锁的附加信息</span><span class="p">,</span><span class="err">例如属于</span><span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">concurrent</span><span class="err">的</span><span class="nx">ownable</span> <span class="nx">synchronizers</span><span class="err">列表</span><span class="p">.</span>
<span class="o">-</span><span class="nx">m</span> <span class="err">打印</span><span class="nx">java</span><span class="err">和</span><span class="kr">native</span> <span class="nx">c</span><span class="o">/</span><span class="nx">c</span><span class="o">++</span><span class="err">框架的所有栈信息</span><span class="p">.</span>
<span class="o">-</span><span class="nx">h</span> <span class="o">|</span> <span class="o">-</span><span class="nx">help</span><span class="err">打印帮助信息</span>
<span class="nx">pid</span> <span class="err">需要被打印配置信息的</span><span class="nx">java</span><span class="err">进程</span><span class="nx">id</span><span class="p">,</span><span class="err">可以用</span><span class="nx">jps</span><span class="err">查询</span><span class="p">.</span>
<span class="o">-</span><span class="err">线程状态</span>
<span class="err">死锁，</span><span class="nx">Deadlock</span><span class="err">（重点关注）</span>
<span class="err">等待资源，</span><span class="nx">Waiting</span> <span class="nx">on</span> <span class="nx">condition</span><span class="err">（重点关注）</span>
<span class="err">等待获取监视器，</span><span class="nx">Waiting</span> <span class="nx">on</span> <span class="nx">monitor</span> <span class="nx">entry</span><span class="err">（重点关注）</span>
<span class="err">阻塞，</span><span class="nx">Blocked</span><span class="err">（重点关注）</span>
<span class="err">执行中，</span><span class="nx">Runnable</span>
<span class="err">暂停，</span><span class="nx">Suspended</span>
<span class="err">对象等待中，</span><span class="nb">Object</span><span class="p">.</span><span class="nx">wait</span><span class="p">()</span> <span class="err">或</span> <span class="nx">TIMED_WAITING</span>
<span class="err">停止，</span><span class="nx">Parked</span>
</code></pre>
</div>

<h6 id="jmap-查看内存">jmap 查看内存</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="nx">jmap</span> <span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="nx">pid</span>
<span class="nx">jmap</span> <span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="nx">executable</span> <span class="nx">core</span>
<span class="nx">jmap</span> <span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="p">[</span><span class="nx">server</span><span class="o">-</span><span class="nx">id</span><span class="err">@</span><span class="p">]</span><span class="nx">remote</span><span class="o">-</span><span class="nx">hostname</span><span class="o">-</span><span class="nx">or</span><span class="o">-</span><span class="nx">IP</span>
<span class="o">-</span><span class="nx">dump</span><span class="err">:</span><span class="p">[</span><span class="nx">live</span><span class="p">]</span><span class="nx">format</span><span class="o">=</span><span class="nx">b</span><span class="p">,</span><span class="nx">file</span><span class="o">=&lt;</span><span class="nx">filename</span><span class="o">&gt;</span> <span class="err">使用</span><span class="nx">hprof</span><span class="err">二进制形式</span><span class="p">,</span><span class="err">输出</span><span class="nx">jvm</span><span class="err">的</span><span class="nx">heap</span><span class="err">内容到文件，假如指定</span><span class="nx">live</span><span class="err">选项</span><span class="p">,</span><span class="err">那么只输出活的对象到文件</span><span class="p">.</span>
<span class="o">-</span><span class="nx">finalizerinfo</span> <span class="err">打印正等候回收的对象的信息</span><span class="p">.</span>
<span class="o">-</span><span class="nx">heap</span> <span class="err">打印</span><span class="nx">heap</span><span class="err">的概要信息，</span><span class="nx">GC</span><span class="err">使用的算法，</span><span class="nx">heap</span><span class="err">的配置及</span><span class="nx">wise</span> <span class="nx">heap</span><span class="err">的使用情况</span><span class="p">.</span>
<span class="o">-</span><span class="nx">histo</span><span class="p">[</span><span class="err">:</span><span class="nx">live</span><span class="p">]</span> <span class="err">打印每个</span><span class="kr">class</span><span class="err">的实例数目</span><span class="p">,</span><span class="err">内存占用</span><span class="p">,</span><span class="err">类全名信息</span><span class="p">.</span> <span class="err">如果</span><span class="nx">live</span><span class="err">子参数加上后</span><span class="p">,</span><span class="err">只统计活的对象数量</span><span class="p">.</span>
<span class="o">-</span><span class="nx">permstat</span> <span class="err">打印</span><span class="nx">classload</span><span class="err">和</span><span class="nx">jvm</span> <span class="nx">heap</span><span class="err">持久层的信息</span><span class="p">.</span> <span class="err">包含每个</span><span class="nx">classloader</span><span class="err">的名字</span><span class="p">,</span><span class="err">活泼性</span><span class="p">,</span><span class="err">地址</span><span class="p">,</span><span class="err">父</span><span class="nx">classloader</span><span class="err">和加载的</span><span class="kr">class</span><span class="err">数量</span><span class="p">.</span> <span class="err">另外</span><span class="p">,</span><span class="err">内部</span><span class="nb">String</span><span class="err">的数量和占用内存数也会打印出来</span><span class="p">.</span>
<span class="o">-</span><span class="nx">h</span> <span class="o">|</span> <span class="o">-</span><span class="nx">help</span> <span class="err">打印辅助信息</span>
<span class="o">-</span><span class="nx">J</span> <span class="err">传递参数给</span><span class="nx">jmap</span><span class="err">启动的</span><span class="nx">jvm</span><span class="p">.</span>
<span class="nx">pid</span> <span class="err">需要被打印配相信息的</span><span class="nx">java</span><span class="err">进程</span><span class="nx">id</span><span class="p">,</span><span class="err">可以用</span><span class="nx">jps</span><span class="err">查看</span>

<span class="nx">jmap</span> <span class="o">-</span><span class="nx">histo</span> <span class="nx">pid</span>  <span class="err">每个</span><span class="kr">class</span><span class="err">的实例数目</span><span class="p">,</span><span class="err">内存占用</span><span class="p">,</span><span class="err">类全名信息</span>
<span class="nx">jmap</span> <span class="o">-</span><span class="nx">histo</span> <span class="mi">4939</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">txt</span>
<span class="nx">jmap</span> <span class="o">-</span><span class="nx">dump</span><span class="err">:</span><span class="nx">format</span><span class="o">=</span><span class="nx">b</span><span class="p">,</span><span class="nx">file</span><span class="o">=</span><span class="nx">fileName</span> <span class="nx">pid</span>
</code></pre>
</div>

<h6 id="jstat-性能分析">jstat 性能分析</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="nx">jstat</span> <span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="p">[</span><span class="nx">pid</span><span class="p">]</span>
<span class="o">-</span><span class="kr">class</span>	<span class="err">用于查看类加载情况的统计</span>
<span class="o">-</span><span class="nx">compiler</span>	<span class="err">用于查看</span><span class="nx">HotSpot</span><span class="err">中即时编译器编译情况的统计</span>
<span class="o">-</span><span class="nx">gc</span>	<span class="err">用于查看</span><span class="nx">JVM</span><span class="err">中堆的垃圾收集情况的统计</span>
<span class="o">-</span><span class="nx">gccapacity</span>	<span class="err">用于查看新生代、老生代及持久代的存储容量情况</span>
<span class="o">-</span><span class="nx">gccause</span>	<span class="err">用于查看垃圾收集的统计情况（这个和</span><span class="o">-</span><span class="nx">gcutil</span><span class="err">选项一样），如果有发生垃圾收集，它还会显示最后一次及当前正在发生垃圾收集的原因。</span>
<span class="o">-</span><span class="nx">gcnew</span>	<span class="err">用于查看新生代垃圾收集的情况</span>
<span class="o">-</span><span class="nx">gcnewcapacity</span>	<span class="err">用于查看新生代的存储容量情况</span>
<span class="o">-</span><span class="nx">gcold</span>	<span class="err">用于查看老生代及持久代发生</span><span class="nx">GC</span><span class="err">的情况</span>
<span class="o">-</span><span class="nx">gcoldcapacity</span>	<span class="err">用于查看老生代的容量</span>
<span class="o">-</span><span class="nx">gcpermcapacity</span>	<span class="err">用于查看持久代的容量</span>
<span class="o">-</span><span class="nx">gcutil</span>	<span class="err">用于查看新生代、老生代及持代垃圾收集的情况</span>
<span class="o">-</span><span class="nx">printcompilation</span>	<span class="nx">HotSpot</span><span class="err">编译方法的统计</span>

<span class="nx">jstat</span> <span class="o">-</span><span class="nx">gcutil</span> <span class="p">[</span><span class="nx">pid</span><span class="p">]</span>
<span class="o">-</span><span class="nx">gcutil</span>  <span class="err">新生代、老生代及持代垃圾收集的情况</span>

<span class="err">列名</span>	<span class="err">说明</span>
<span class="nx">S0</span>	<span class="nx">Heap</span><span class="err">上的</span> <span class="nx">Survivor</span> <span class="nx">space</span> <span class="mi">0</span> <span class="err">区已使用空间的百分比</span>
<span class="nx">S1</span>	<span class="nx">Heap</span><span class="err">上的</span> <span class="nx">Survivor</span> <span class="nx">space</span> <span class="mi">1</span> <span class="err">区已使用空间的百分比</span>
<span class="nx">E</span>	<span class="nx">Heap</span><span class="err">上的</span> <span class="nx">Eden</span> <span class="nx">space</span> <span class="err">区已使用空间的百分比</span>
<span class="nx">O</span>	<span class="nx">Heap</span><span class="err">上的</span> <span class="nx">Old</span> <span class="nx">space</span> <span class="err">区已使用空间的百分比</span>
<span class="nx">P</span>	<span class="nx">Perm</span> <span class="nx">space</span> <span class="err">区已使用空间的百分比</span>
<span class="nx">YGC</span>	<span class="err">从应用程序启动到采样时发生</span> <span class="nx">Young</span> <span class="nx">GC</span> <span class="err">的次数</span>
<span class="nx">YGCT</span>	<span class="err">从应用程序启动到采样时</span> <span class="nx">Young</span> <span class="nx">GC</span> <span class="err">所用的时间</span><span class="p">(</span><span class="err">单位秒</span><span class="p">)</span>
<span class="nx">FGC</span>	<span class="err">从应用程序启动到采样时发生</span> <span class="nx">Full</span> <span class="nx">GC</span> <span class="err">的次数</span>
<span class="nx">FGCT</span>	<span class="err">从应用程序启动到采样时</span> <span class="nx">Full</span> <span class="nx">GC</span> <span class="err">所用的时间</span><span class="p">(</span><span class="err">单位秒</span><span class="p">)</span>
<span class="nx">GCT</span>	<span class="err">从应用程序启动到采样时用于垃圾回收的总时间</span><span class="p">(</span><span class="err">单位秒</span><span class="p">)</span><span class="err">，它的值等于</span><span class="nx">YGC</span><span class="o">+</span><span class="nx">FGC</span>
</code></pre>
</div>

<h6 id="堆内存--年轻代--年老代--永久代-----年轻代--eden区--2sourvivor区fromto">堆内存 = 年轻代 + 年老代 + 永久代     年轻代 = Eden区 + 2Sourvivor区(From/To)</h6>

<h5 id="jvm-参数设置">JVM 参数设置</h5>

<h6 id="堆设置">堆设置</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="o">-</span><span class="nx">Xmx3550m</span><span class="err">：设置</span><span class="nx">JVM</span><span class="err">最大堆内存为</span><span class="mi">3550</span><span class="nx">M</span><span class="err">。</span>
<span class="o">-</span><span class="nx">Xms3550m</span><span class="err">：设置</span><span class="nx">JVM</span><span class="err">初始堆内存为</span><span class="mi">3550</span><span class="nx">M</span><span class="err">。此值可以设置与</span><span class="o">-</span><span class="nx">Xmx</span><span class="err">相同，以避免每次垃圾回收完成后</span><span class="nx">JVM</span><span class="err">重新分配内存。</span>
<span class="o">-</span><span class="nx">Xss128k</span><span class="err">：</span> <span class="err">设置每个线程的栈大小。</span><span class="nx">JDK5</span><span class="p">.</span><span class="err">以后每个线程栈大小为</span><span class="mi">1</span><span class="nx">M</span><span class="err">，之前每个线程栈大小为</span><span class="mi">256</span><span class="nx">K</span><span class="err">。</span>
        <span class="err">应当根据应用的线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。</span>
        <span class="err">但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在</span> <span class="mi">3000</span><span class="o">~</span><span class="mi">5000</span> <span class="err">左右。</span>
<span class="o">-</span><span class="nx">Xmn2g</span><span class="err">：设置堆内存年轻代大小为</span><span class="mi">2</span><span class="nx">G</span><span class="err">。整个堆内存大小</span> <span class="o">=</span> <span class="err">年轻代大小</span> <span class="o">+</span> <span class="err">年老代大小</span> <span class="o">+</span> <span class="err">持久代大小</span> <span class="err">。</span>
        <span class="err">持久代一般固定大小为</span><span class="mi">64</span><span class="nx">m</span><span class="err">，所以增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，</span><span class="nx">Sun</span><span class="err">官方推荐配置为整个堆的</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="err">。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">PermSize</span><span class="o">=</span><span class="mi">256</span><span class="nx">M</span><span class="err">：设置堆内存持久代</span> <span class="err">初始值为</span><span class="mi">256</span><span class="nx">M</span><span class="err">。</span><span class="p">(</span><span class="err">貌似是</span><span class="nx">Eclipse</span><span class="err">等</span><span class="nx">IDE</span><span class="err">的初始化参数</span><span class="p">)</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxNewSize</span><span class="o">=</span><span class="nx">size</span><span class="err">：新生成的对象能占用内存的最大值。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxPermSize</span><span class="o">=</span><span class="mi">512</span><span class="nx">M</span><span class="err">：设置持久代最大值为</span><span class="mi">512</span><span class="nx">M</span><span class="err">。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">NewRatio</span><span class="o">=</span><span class="mi">4</span><span class="err">：设置堆内存年轻代（包括</span><span class="nx">Eden</span><span class="err">和两个</span><span class="nx">Survivor</span><span class="err">区）与堆内存年老代的比值（除去持久代）</span> <span class="err">。</span>
        <span class="err">设置为</span><span class="mi">4</span><span class="err">，则年轻代所占与年老代所占的比值为</span><span class="mi">1</span><span class="err">:</span><span class="mi">4</span><span class="err">。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">SurvivorRatio</span><span class="o">=</span><span class="mi">4</span><span class="err">：设置堆内存年轻代中</span><span class="nx">Eden</span><span class="err">区与</span><span class="nx">Survivor</span><span class="err">区大小的比值</span> <span class="err">。</span>
        <span class="err">设置为</span><span class="mi">4</span><span class="err">，则两个</span><span class="nx">Survivor</span><span class="err">区（</span><span class="nx">JVM</span><span class="err">堆内存年轻代中默认有</span><span class="mi">2</span><span class="err">个</span><span class="nx">Survivor</span><span class="err">区）与一个</span><span class="nx">Eden</span><span class="err">区的比值为</span><span class="mi">2</span><span class="err">:</span><span class="mi">4</span><span class="err">，</span>
        <span class="err">一个</span><span class="nx">Survivor</span><span class="err">区占</span> <span class="err">整个年轻代的</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="err">。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxTenuringThreshold</span><span class="o">=</span><span class="mi">7</span><span class="err">：表示一个对象如果在救助空间（</span><span class="nx">Survivor</span><span class="err">区）移动</span><span class="mi">7</span><span class="err">次还没有被回收就放入年老代。</span>
        <span class="err">如果设置为</span><span class="mi">0</span><span class="err">的话，则年轻代对象不经过</span><span class="nx">Survivor</span><span class="err">区，直接进入年老代，对于年老代比较多的应用，这样做可以提高效率。</span>
        <span class="err">如果将此值设置为一个较大值，则年轻代对象会在</span><span class="nx">Survivor</span><span class="err">区进行多次复制，这样可以增加对象在年轻代存活时间，</span>
        <span class="err">增加对象在年轻代即被回收的概率。</span>
</code></pre>
</div>

<h5 id="回收器选择">回收器选择</h5>

<h6 id="串行收集器">串行收集器</h6>

<p>-XX:+UseSerialGC：设置串行收集器</p>

<h6 id="并行收集器吞吐量优先">并行收集器(吞吐量优先)</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseParallelGC</span><span class="err">：选择垃圾收集器为并行收集器。此配置仅对年轻代有效。即上述配置下，年轻代使用并发收集，而年老代仍旧使用串行收集。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">ParallelGCThreads</span><span class="o">=</span><span class="mi">20</span><span class="err">：配置并行收集器的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相等。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseParallelOldGC</span><span class="err">：配置年老代垃圾收集方式为并行收集。</span><span class="nx">JDK6</span><span class="p">.</span><span class="mi">0</span><span class="err">支持对年老代并行收集。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxGCPauseMillis</span><span class="o">=</span><span class="mi">100</span><span class="err">：设置每次年轻代垃圾回收的最长时间（单位毫秒），如果无法满足此时间，</span><span class="nx">JVM</span><span class="err">会自动调整年轻代大小，以满足此值。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseAdaptiveSizePolicy</span><span class="err">：设置此选项后，并行收集器会自动选择年轻代区大小和相应的</span><span class="nx">Survivor</span><span class="err">区比例，</span>
          <span class="err">以达到目标系统规定的最低响应时间或者收集频率等。此参数建议使用并行收集器时，一直打开。</span>
</code></pre>
</div>

<h6 id="并发收集器响应时间优先">并发收集器(响应时间优先)</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseParNewGC</span><span class="err">：设置年轻代为并发收集。可与</span><span class="nx">CMS</span><span class="err">收集同时使用。</span><span class="nx">JDK5</span><span class="p">.</span><span class="mi">0</span><span class="err">以上，</span><span class="nx">JVM</span><span class="err">会根据系统配置自行设置，所以无需再设置此值。</span>
          <span class="nx">CMS</span><span class="err">，</span> <span class="err">全称</span><span class="nx">Concurrent</span> <span class="nx">Low</span> <span class="nx">Pause</span> <span class="nx">Collector</span><span class="err">，是</span><span class="nx">jdk1</span><span class="p">.</span><span class="mi">4</span><span class="err">后期版本开始引入的新</span><span class="nx">gc</span><span class="err">算法，在</span><span class="nx">jdk5</span><span class="err">和</span><span class="nx">jdk6</span><span class="err">中得到了进一步改进，</span>
          <span class="err">它的主要适合场景是对响应时间的重要性需求</span> <span class="err">大于对吞吐量的要求，能够承受垃圾回收线程和应用线程共享处理器资源，</span>
          <span class="err">并且应用中存在比较多的长生命周期的对象的应用。</span><span class="nx">CMS</span><span class="err">是用于对</span><span class="nx">tenured</span> <span class="nx">generation</span><span class="err">的回收，也就是年老代的回收，</span>
          <span class="err">目标是尽量减少应用的暂停时间，减少</span><span class="nx">FullGC</span><span class="err">发生的几率，利用和应用程序线程并发的垃圾回收线程来</span> <span class="err">标记清除年老代。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseConcMarkSweepGC</span><span class="err">：设置年老代为并发收集。</span>
          <span class="err">测试中配置这个以后，</span><span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">NewRatio</span><span class="o">=</span><span class="mi">4</span><span class="err">的配置失效了。所以，此时年轻代大小最好用</span><span class="o">-</span><span class="nx">Xmn</span><span class="err">设置。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">CMSFullGCsBeforeCompaction</span><span class="o">=</span><span class="err">：由于并发收集器不对内存空间进行压缩、整理，</span>
          <span class="err">所以运行一段时间以后会产生“碎片”，使得运行效率降低。此参数设置运行次</span><span class="nx">FullGC</span><span class="err">以后对内存空间进行压缩、整理。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseCMSCompactAtFullCollection</span><span class="err">：打开对年老代的压缩。可能会影响性能，但是可以消除内存碎片。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">CMSIncrementalMode</span><span class="err">：设置为增量收集模式。一般适用于单</span><span class="nx">CPU</span><span class="err">情况。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">CMSInitiatingOccupancyFraction</span><span class="o">=</span><span class="mi">70</span><span class="err">：表示年老代空间到</span><span class="mi">70</span><span class="o">%</span><span class="err">时就开始执行</span><span class="nx">CMS</span><span class="err">，确保年老代有足够的空间接纳来自年轻代的对象。</span>
<span class="err">注：如果使用</span> <span class="nx">throughput</span> <span class="nx">collector</span> <span class="err">和</span> <span class="nx">concurrent</span> <span class="nx">low</span> <span class="nx">pause</span> <span class="nx">collector</span> <span class="err">这两种垃圾收集器，需要适当的挺高内存大小，为多线程做准备。</span>

<span class="err">其它</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">ScavengeBeforeFullGC</span><span class="err">：新生代</span><span class="nx">GC</span><span class="err">优先于</span><span class="nx">Full</span> <span class="nx">GC</span><span class="err">执行。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">DisableExplicitGC</span><span class="err">：禁止调用</span><span class="nx">System</span><span class="p">.</span><span class="nx">gc</span><span class="p">()</span><span class="err">，但</span><span class="nx">JVM</span><span class="err">的</span><span class="nx">gc</span><span class="err">仍然有效。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">MaxFDLimit</span><span class="err">：最大化文件描述符的数量限制。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseThreadPriorities</span><span class="err">：启用本地线程优先级</span><span class="nx">API</span><span class="err">，即使</span> <span class="nx">java</span><span class="p">.</span><span class="nx">lang</span><span class="p">.</span><span class="nx">Thread</span><span class="p">.</span><span class="nx">setPriority</span><span class="p">()</span> <span class="err">生效，反之无效。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">SoftRefLRUPolicyMSPerMB</span><span class="o">=</span><span class="mi">0</span><span class="err">：“软引用”的对象在最后一次被访问后能存活</span><span class="mi">0</span><span class="err">毫秒（默认为</span><span class="mi">1</span><span class="err">秒）。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">TargetSurvivorRatio</span><span class="o">=</span><span class="mi">90</span><span class="err">：允许</span><span class="mi">90</span><span class="o">%</span><span class="err">的</span><span class="nx">Survivor</span><span class="err">空间被占用（默认为</span><span class="mi">50</span><span class="o">%</span><span class="err">）。提高对于</span><span class="nx">Survivor</span><span class="err">的使用率——超过就会尝试垃圾回收。</span>
</code></pre>
</div>

<h6 id="辅助信息">辅助信息</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">CITime</span><span class="err">：打印消耗在</span><span class="nx">JIT</span><span class="err">编译的时间</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">ErrorFile</span><span class="o">=</span><span class="p">.</span><span class="o">/</span><span class="nx">hs_err_pid</span><span class="p">.</span><span class="nx">log</span><span class="err">：保存错误日志或者数据到指定文件中</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">ExtendedDTraceProbes</span><span class="err">：开启</span><span class="nx">solaris</span><span class="err">特有的</span><span class="nx">dtrace</span><span class="err">探针</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">HeapDumpPath</span><span class="o">=</span><span class="p">.</span><span class="o">/</span><span class="nx">java_pid</span><span class="p">.</span><span class="nx">hprof</span><span class="err">：指定导出堆信息时的路径或文件名</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">HeapDumpOnOutOfMemoryError</span><span class="err">：当首次遭遇内存溢出时导出此时堆中相关信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">OnError</span><span class="o">=</span><span class="s2">";"</span><span class="err">：出现致命</span><span class="nx">ERROR</span><span class="err">之后运行自定义命令</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">OnOutOfMemoryError</span><span class="o">=</span><span class="s2">";"</span><span class="err">：当首次遭遇内存溢出时执行自定义命令</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintClassHistogram</span><span class="err">：遇到</span><span class="nx">Ctrl</span><span class="o">-</span><span class="nx">Break</span><span class="err">后打印类实例的柱状信息，与</span><span class="nx">jmap</span> <span class="o">-</span><span class="nx">histo</span><span class="err">功能相同</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintConcurrentLocks</span><span class="err">：遇到</span><span class="nx">Ctrl</span><span class="o">-</span><span class="nx">Break</span><span class="err">后打印并发锁的相关信息，与</span><span class="nx">jstack</span> <span class="o">-</span><span class="nx">l</span><span class="err">功能相同</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintCommandLineFlags</span><span class="err">：打印在命令行中出现过的标记</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintCompilation</span><span class="err">：当一个方法被编译时打印相关信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintGC</span><span class="err">：每次</span><span class="nx">GC</span><span class="err">时打印相关信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintGC</span> <span class="nx">Details</span><span class="err">：每次</span><span class="nx">GC</span><span class="err">时打印详细信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">PrintGCTimeStamps</span><span class="err">：打印每次</span><span class="nx">GC</span><span class="err">的时间戳</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">TraceClassLoading</span><span class="err">：跟踪类的加载信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">TraceClassLoadingPreorder</span><span class="err">：跟踪被引用到的所有类的加载信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">TraceClassResolution</span><span class="err">：跟踪常量池</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">TraceClassUnloading</span><span class="err">：跟踪类的卸载信息</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">-</span><span class="nx">TraceLoaderConstraints</span><span class="err">：跟踪类加载器约束的相关信息</span>
</code></pre>
</div>

<h6 id="jvm服务调优实战">JVM服务调优实战</h6>

<div class="language-js highlighter-rouge"><pre class="highlighter"><code><span class="err">服务器：</span><span class="mi">8</span> <span class="nx">cup</span><span class="p">,</span> <span class="mi">8</span><span class="nx">G</span> <span class="nx">mem</span>
<span class="nx">java</span> <span class="o">-</span><span class="nx">Xmx3550m</span> <span class="o">-</span><span class="nx">Xms3550m</span> <span class="o">-</span><span class="nx">Xss128k</span> <span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">NewRatio</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">SurvivorRatio</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxPermSize</span><span class="o">=</span><span class="mi">16</span><span class="nx">m</span> <span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxTenuringThreshold</span><span class="o">=</span><span class="mi">0</span>
<span class="err">调优方案：</span>
<span class="o">-</span><span class="nx">Xmx5g</span><span class="err">：设置</span><span class="nx">JVM</span><span class="err">最大可用内存为</span><span class="mi">5</span><span class="nx">G</span><span class="err">。</span>
<span class="o">-</span><span class="nx">Xms5g</span><span class="err">：设置</span><span class="nx">JVM</span><span class="err">初始内存为</span><span class="mi">5</span><span class="nx">G</span><span class="err">。此值可以设置与</span><span class="o">-</span><span class="nx">Xmx</span><span class="err">相同，以避免每次垃圾回收完成后</span><span class="nx">JVM</span><span class="err">重新分配内存。</span>
<span class="o">-</span><span class="nx">Xmn2g</span><span class="err">：设置年轻代大小为</span><span class="mi">2</span><span class="nx">G</span><span class="err">。整个堆内存大小</span> <span class="o">=</span> <span class="err">年轻代大小</span> <span class="o">+</span> <span class="err">年老代大小</span> <span class="o">+</span> <span class="err">持久代大小</span> <span class="err">。持久代一般固定大小为</span><span class="mi">64</span><span class="nx">m</span><span class="err">，</span>
        <span class="err">所以增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，</span><span class="nx">Sun</span><span class="err">官方推荐配置为整个堆的</span><span class="mi">3</span><span class="o">/</span><span class="mi">8</span><span class="err">。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseParNewGC</span><span class="err">：设置年轻代为并行收集。可与</span><span class="nx">CMS</span><span class="err">收集同时使用。</span><span class="nx">JDK5</span><span class="p">.</span><span class="mi">0</span><span class="err">以上，</span><span class="nx">JVM</span><span class="err">会根据系统配置自行设置，所以无需再设置此值。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">ParallelGCThreads</span><span class="o">=</span><span class="mi">8</span><span class="err">：配置并行收集器的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相等。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">SurvivorRatio</span><span class="o">=</span><span class="mi">6</span><span class="err">：设置年轻代中</span><span class="nx">Eden</span><span class="err">区与</span><span class="nx">Survivor</span><span class="err">区的大小比值。根据经验设置为</span><span class="mi">6</span><span class="err">，则两个</span><span class="nx">Survivor</span><span class="err">区与一个</span><span class="nx">Eden</span><span class="err">区的比值为</span><span class="mi">2</span><span class="err">:</span><span class="mi">6</span><span class="err">，</span>
        <span class="err">一个</span><span class="nx">Survivor</span><span class="err">区占整个年轻代的</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="err">。</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">MaxTenuringThreshold</span><span class="o">=</span><span class="mi">30</span><span class="err">：</span> <span class="err">设置垃圾最大年龄（次数）。如果设置为</span><span class="mi">0</span><span class="err">的话，则年轻代对象不经过</span><span class="nx">Survivor</span><span class="err">区直接进入年老代。</span>
        <span class="err">对于年老代比较多的应用，可以提高效率。如果将此值</span> <span class="err">设置为一个较大值，则年轻代对象会在</span><span class="nx">Survivor</span><span class="err">区进行多次复制，</span>
        <span class="err">这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概率。设置为</span><span class="mi">30</span><span class="err">表示</span>
        <span class="err">一个对象如果在</span><span class="nx">Survivor</span><span class="err">空间移动</span><span class="mi">30</span><span class="err">次还没有被回收就放入年老代</span>
<span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="o">+</span><span class="nx">UseConcMarkSweepGC</span><span class="err">：设置年老代为并发收集。测试配置这个参数以后，参数</span><span class="o">-</span><span class="nx">XX</span><span class="err">:</span><span class="nx">NewRatio</span><span class="o">=</span><span class="mi">4</span><span class="err">就失效了，</span>
        <span class="err">所以，此时年轻代大小最好用</span><span class="o">-</span><span class="nx">Xmn</span><span class="err">设置，因此这个参数不建议使用。</span>
</code></pre>
</div>

<h6 id="堆溢时会将堆栈信息输出到文件中的配置">堆溢时会将堆栈信息输出到文件中的配置</h6>

<ul>
  <li>-XX:+HeapDumpOnOutOfMemoryError-XX:HeapDumpPath=/path/to/heap/dump</li>
</ul>

    </article>
  </div>

  <div class="related">
    <h4>最新文章</h4>
    <ul class="related-posts">
      
        <li>
          <h5>
            <a href="/books/2017/08/18/%E5%86%85%E5%90%91%E8%80%85%E4%BC%98%E5%8A%BF.html">
              内向者优势
              <small>2017-08-18</small>
            </a>
          </h5>
        </li>
      
        <li>
          <h5>
            <a href="/architecture/2017/08/10/%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF.html">
              亿级流量网站架构核心技术
              <small>2017-08-10</small>
            </a>
          </h5>
        </li>
      
        <li>
          <h5>
            <a href="/architecture/2017/07/26/%E9%87%8D%E6%9E%84%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1.html">
              重构-改善既有代码的设计
              <small>2017-07-26</small>
            </a>
          </h5>
        </li>
      
    </ul>
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'michaelygzhangblog';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:g.zhangyg@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/MichaelYgZhang"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/michaelygzhang"><i class="svg-icon twitter"></i></a>


<a href="https://plus.google.com/115646538142388831563"><i class="svg-icon googleplus"></i></a>

        </footer>
      </div>
    </div>

    <div id="backToTop" class="backtoTop">
    	<i class="fa fa-hand-o-up fa-2x"></i>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-84531968-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/java/2016/12/31/JVM-practice.html',
		  'title': 'JVM Optimize Practice'
		});
	</script>
	<!-- End Google Analytics -->


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.1.5/jekyll-search.js" type="text/javascript"></script>
    <script src="/js/blog.js" type="text/javascript"></script>

    <script type="text/javascript">
          SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            json: '/search.json',
            searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
            noResultsText: 'No results found',
            limit: 10,
            fuzzy: false,
            exclude: ['Welcome']
          })
    </script>
  </body>
</html>
