<!DOCTYPE html>
<html>
  <head>
    <title>Cache – Michael – Developer</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Wheel Cache" />
    <meta property="og:description" content="Wheel Cache" />
    
    <meta name="author" content="Michael" />

    
    <meta property="og:title" content="Cache" />
    <meta property="twitter:title" content="Cache" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Michael - Developer" href="/feed.xml" />
    <link rel="shortcut icon" href="/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"/>
  </head>

  <body>

    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/favicon.ico" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Michael</a></h1>
            <p class="site-description">Developer</p>
          </div>

          <nav>
            <a href="/"><i class="fa fa-home fa-2x"></i></a>
            <a href="/category"><i class="fa fa-tags fa-2x" aria-hidden="true"></i></a>
            <a href="/about"><i class="fa fa-user-secret fa-2x"></i></a>
            <a href="/blog"><i class="fa fa-university fa-2x"></i></a>
            <!-- <a href="/task"><i class="fa fa-book fa-2x" aria-hidden="true"></i></a> -->
            <a href="/feed.xml" target="_blank"><i class="fa fa-feed fa-2x"></i></a>

            <!-- 
            
              
            
              
            
              
              <a href="/" >
                Home
              </a>
              
            
              
              <a href="/blog" >
                Blog
              </a>
              
            
              
              <a href="/category" >
                Category
              </a>
              
             -->
          </nav>

          <a href="https://github.com/MichaelYgZhang" target="_blank">
            <img class="fork-me-on-github" src="/images/fork-me-on-github.png" alt="Fork me on GitHub">
          </a>
        </header>

        <div id="search-container">
          <input type="text" id="search-input" placeholder="search...">
          <ul id="results-container"></ul>
        </div>

      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <div class="post">
    <h1 class="post-title">Cache</h1>
    <span class="post-date">2016-12-27</span>
    <!--  |
    
     -->
    <article>
      <h5 id="缓存支持过期时间设置池子满时默认采用fifo算法可替换其他算法清除修噶多线程操作设计思路与concurrenthashmap类似两者有很多共同点">缓存，支持过期时间设置，池子满时默认采用FIFO算法可替换其他算法，清除，修噶，多线程操作。设计思路与ConcurrentHashMap类似，两者有很多共同点。</h5>

<div class="language-java highlighter-rouge"><pre class="highlighter"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ICache</span> <span class="kd">extends</span> <span class="n">Serializable</span><span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">putCache</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span><span class="n">String</span> <span class="n">elmkey</span><span class="o">,</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span><span class="kt">long</span> <span class="n">times</span><span class="o">);</span>
	<span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">PutAndUpdateCache</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span><span class="n">String</span> <span class="n">elmkey</span><span class="o">,</span><span class="n">Object</span> <span class="n">value</span><span class="o">,</span><span class="kt">long</span> <span class="n">times</span><span class="o">);</span>
	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span><span class="n">String</span> <span class="n">elmkey</span><span class="o">);</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span><span class="n">Long</span><span class="o">&gt;</span> <span class="nf">getCacheDetail</span><span class="o">();</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">block</span><span class="o">,</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeCacheByBlockName</span><span class="o">(</span><span class="n">String</span> <span class="n">blockName</span><span class="o">);</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stopCache</span><span class="o">();</span>
<span class="o">}</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlighter"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CacheImpl</span> <span class="kd">implements</span> <span class="n">ICache</span><span class="o">{</span>

	<span class="cm">/**
	 * 最大缓存数量
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kd">private</span> <span class="kt">int</span> <span class="n">MAXCACHESIZE</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span>
	<span class="cm">/**
	 * 散列映射表的默认初始容量为 16，即初始默认为 16 个桶 在构造函数中没有指定这个参数时，使用本参数
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_INITIAL_CAPACITY</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>

	<span class="cm">/**
	 * 散列映射表的默认装载因子为 0.75，该值是 table 中包含的 HashEntry 元素的个数与 table 数组长度的比值 当 table
	 * 中包含的 HashEntry 元素的个数超过了 table 数组的长度与装载因子的乘积时， 将触发 再散列
	 * 在构造函数中没有指定这个参数时，使用本参数
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">DEFAULT_LOAD_FACTOR</span> <span class="o">=</span> <span class="mf">0.75f</span><span class="o">;</span>

	<span class="cm">/**
	 * 散列表的默认并发级别为 16。该值表示当前更新线程的估计数 在构造函数中没有指定这个参数时，使用本参数
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DEFAULT_CONCURRENCY_LEVEL</span> <span class="o">=</span> <span class="mi">16</span><span class="o">;</span>

	<span class="cm">/**
	 * 散列映射表最大的容量
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAXIMUM_CAPACITY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="o">;</span>

	<span class="cm">/**
	 * 最大的缓存片个数
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">MAX_SEGMENTS</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="c1">// slightly conservative</span>

	<span class="cm">/* ---------------- Fields -------------- */</span>

	<span class="cm">/**
	 * segments 的掩码值 key 的散列码的高位用来选择具体的 segment
	 */</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">segmentMask</span><span class="o">;</span>

	<span class="cm">/**
	 * 偏移量
	 */</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">segmentShift</span><span class="o">;</span>

	<span class="cm">/**
	 * 定位到缓存片的hash算法
	 *
	 * @param h
	 * @return
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="kt">int</span> <span class="n">h</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// Spread bits to regularize both segment and index locations,</span>
		<span class="c1">// using variant of single-word Wang/Jenkins hash.</span>
		<span class="n">h</span> <span class="o">+=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="o">)</span> <span class="o">^</span> <span class="mh">0xffffcd7d</span><span class="o">;</span>
		<span class="n">h</span> <span class="o">^=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">10</span><span class="o">);</span>
		<span class="n">h</span> <span class="o">+=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="o">);</span>
		<span class="n">h</span> <span class="o">^=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">6</span><span class="o">);</span>
		<span class="n">h</span> <span class="o">+=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="o">(</span><span class="n">h</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">h</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">final</span> <span class="n">Cache</span> <span class="nf">cacheFor</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[(</span><span class="n">hash</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">segmentShift</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">segmentMask</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 缓存实体
	 *
s	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">CacheEntry</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
		<span class="cm">/**
		 *
		 */</span>
		<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7664619266911312995L</span><span class="o">;</span>
		<span class="kd">final</span> <span class="n">String</span> <span class="n">key</span><span class="o">;</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span>
		<span class="kd">volatile</span> <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>
		<span class="kd">volatile</span> <span class="kt">long</span> <span class="n">livetime</span><span class="o">;</span>
		<span class="kd">final</span> <span class="n">CacheEntry</span> <span class="n">next</span><span class="o">;</span>

		<span class="n">CacheEntry</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">CacheEntry</span> <span class="n">next</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">livetime</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">livetime</span> <span class="o">=</span> <span class="n">livetime</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kd">static</span> <span class="kd">final</span> <span class="n">CacheEntry</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="n">CacheEntry</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * The segments, each of which is a specialized hash table
	 */</span>
	<span class="kd">final</span> <span class="n">Cache</span><span class="o">[]</span> <span class="n">caches</span><span class="o">;</span>

	<span class="cm">/**
	 * 缓存片
	 */</span>
	<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Cache</span> <span class="kd">extends</span> <span class="n">ReentrantLock</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
		<span class="cm">/**
		 *
		 */</span>
		<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">3015261008227415326L</span><span class="o">;</span>
		<span class="cm">/**
		 * 每一块缓存最大缓存个数
		 */</span>
		<span class="kd">transient</span> <span class="kt">int</span> <span class="n">maxcache</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="cm">/**
		 * 在本 Cache 范围内，包含的 CahceEntry 元素的个数 该变量被声明为 volatile 型
		 */</span>
		<span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

		<span class="cm">/**
		 * 线程是否开始清除缓存
		 */</span>
		<span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="cm">/**
		 * table 被更新的次数
		 */</span>
		<span class="kd">transient</span> <span class="kt">int</span> <span class="n">modCount</span><span class="o">;</span>

		<span class="cm">/**
		 * 当 table 中包含的 CacheEntry 元素的个数超过本变量值时，触发 table 的再散列
		 */</span>
		<span class="kd">transient</span> <span class="kt">int</span> <span class="n">threshold</span><span class="o">;</span>

		<span class="cm">/**
		 * table 是由 CacheEntry 对象组成的数组 如果散列时发生碰撞，碰撞的 CacheEntry 对象就以链表的形式链接成一个链表
		 * table 数组的数组成员代表散列映射表的一个桶 每个 table 守护整个 ConcurrentCache 包含桶总数的一部分
		 * 如果并发级别为 16，table 则守护 ConcurrentCache 包含的桶总数的 1/16
		 */</span>
		<span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">table</span><span class="o">;</span>
		<span class="cm">/**
		 * 总的插入次数
		 */</span>
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">totalput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="cm">/**
		 * 总的get次数
		 */</span>
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">totalget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
		<span class="cm">/**
		 * 总的get成功次数
		 */</span>
		<span class="kd">private</span> <span class="kd">final</span> <span class="n">AtomicLong</span> <span class="n">totalgetsuccesses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

		<span class="cm">/**
		 * 装载因子
		 */</span>
		<span class="kd">final</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">;</span>

		<span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>

		<span class="n">Cache</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">float</span> <span class="n">lf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">maxcache</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">loadFactor</span> <span class="o">=</span> <span class="n">lf</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">maxcache</span> <span class="o">=</span> <span class="n">maxcache</span><span class="o">;</span>
			<span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
			<span class="n">setTable</span><span class="o">(</span><span class="n">CacheEntry</span><span class="o">.</span><span class="na">newArray</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">));</span>
		<span class="o">}</span>

		<span class="kd">static</span> <span class="kd">final</span> <span class="n">Cache</span><span class="o">[]</span> <span class="nf">newArray</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">new</span> <span class="n">Cache</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 设置 table 引用到这个新生成的CacheEntry 数组 只能在持有锁或构造函数中调用本方法
		 */</span>
		<span class="kt">void</span> <span class="nf">setTable</span><span class="o">(</span><span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">newTable</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">threshold</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">newTable</span><span class="o">.</span><span class="na">length</span> <span class="o">*</span> <span class="n">loadFactor</span><span class="o">);</span>
			<span class="n">table</span> <span class="o">=</span> <span class="n">newTable</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 根据 key 的散列值，找到 table 中对应的那个桶（table 数组的某个数组成员）
		 */</span>
		<span class="n">CacheEntry</span> <span class="nf">getFirst</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
			<span class="k">return</span> <span class="n">tab</span><span class="o">[</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)];</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">long</span> <span class="nf">getTotalput</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">totalput</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">long</span> <span class="nf">getTotalget</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">totalget</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">long</span> <span class="nf">getTotalGetSuccesses</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">totalgetsuccesses</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * get的时候如果已经找到对应的key了，但是返回的是null值，则又可能当时正有读操作,加锁在读一次
		 * @param e
		 * @return
		 */</span>
		<span class="n">Object</span> <span class="nf">readValueUnderLock</span><span class="o">(</span><span class="n">CacheEntry</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">lock</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">unlock</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 设置调取成功统计
		 */</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGetSuccesses</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">this</span><span class="o">.</span><span class="na">totalgetsuccesses</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="n">Object</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">totalget</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// read-volatile</span>
				<span class="n">CacheEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">getFirst</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">))</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">livetime</span><span class="o">)</span>
							<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
						<span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
							<span class="k">return</span> <span class="n">v</span><span class="o">;</span>
						<span class="k">return</span> <span class="nf">readValueUnderLock</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="c1">// recheck</span>
					<span class="o">}</span>
					<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="n">KeyLinked</span> <span class="n">head</span><span class="o">;</span>

		<span class="kd">public</span> <span class="n">KeyLinked</span> <span class="n">current</span><span class="o">;</span>

		<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">KeyLinked</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
			<span class="cm">/**
			 *
			 */</span>
			<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2057372648832421472L</span><span class="o">;</span>
			<span class="kd">public</span> <span class="n">String</span> <span class="n">key</span><span class="o">;</span>
			<span class="kd">public</span> <span class="n">KeyLinked</span> <span class="n">next</span><span class="o">;</span>
			<span class="c1">// public KeyLinked head;</span>
		<span class="o">}</span>

		<span class="n">Object</span> <span class="nf">put</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">,</span> <span class="kt">long</span> <span class="n">livetime</span><span class="o">)</span> <span class="o">{</span>
			<span class="cm">/**
			 * 如果线程开始清除缓存，拒绝所有的put操作
			 */</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">startclearcache</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"cache"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">+</span> <span class="s">"put refuse"</span><span class="o">);</span>
				<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">lock</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">totalput</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span> <span class="c1">// ensure capacity</span>
					<span class="n">rehash</span><span class="o">();</span>
				<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
				<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
				<span class="n">CacheEntry</span> <span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
				<span class="n">CacheEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">!=</span> <span class="n">hash</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)))</span>
					<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
				<span class="n">Object</span> <span class="n">oldValue</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">oldValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
					<span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
					<span class="n">e</span><span class="o">.</span><span class="na">livetime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">livetime</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
					<span class="n">oldValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
					<span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheEntry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="n">first</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="o">(</span><span class="n">livetime</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">));</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// write-volatile</span>
					<span class="cm">/**
					 * 加入链表key
					 */</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">head</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyLinked</span><span class="o">();</span>
						<span class="n">head</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
						<span class="n">current</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
					<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
						<span class="n">KeyLinked</span> <span class="n">k</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyLinked</span><span class="o">();</span>
						<span class="n">k</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
							<span class="n">current</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
						<span class="n">current</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
						<span class="n">current</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="cm">/**
				 * 如果该片缓存大于最大个数了，删除其中一个值 fifo淘汰策略
				 */</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">maxcache</span> <span class="o">&amp;&amp;</span> <span class="n">head</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="cm">/**
					 * 找到最老的key
					 */</span>
					<span class="n">String</span> <span class="n">oldkey</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">oldkey</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="cm">/**
						 * 从map中移除
						 */</span>
						<span class="kt">int</span> <span class="n">hash1</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">oldkey</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
						<span class="k">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">oldkey</span><span class="o">,</span> <span class="n">hash1</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
						<span class="cm">/**
						 * 从链表中移除
						 */</span>
						<span class="n">KeyLinked</span> <span class="n">newhead</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
						<span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
						<span class="n">head</span> <span class="o">=</span> <span class="n">newhead</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"concurrentcache"</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">+</span> <span class="s">" size:"</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">==</span> <span class="mi">100000000</span><span class="o">)</span>
					<span class="n">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">unlock</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kt">void</span> <span class="nf">rehash</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">oldTable</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">oldCapacity</span> <span class="o">=</span> <span class="n">oldTable</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">oldCapacity</span> <span class="o">&gt;=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span>
				<span class="k">return</span><span class="o">;</span>
			<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">newTable</span> <span class="o">=</span> <span class="n">CacheEntry</span><span class="o">.</span><span class="na">newArray</span><span class="o">(</span><span class="n">oldCapacity</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">);</span>
			<span class="n">threshold</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">newTable</span><span class="o">.</span><span class="na">length</span> <span class="o">*</span> <span class="n">loadFactor</span><span class="o">);</span>
			<span class="kt">int</span> <span class="n">sizeMask</span> <span class="o">=</span> <span class="n">newTable</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">oldCapacity</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">CacheEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">oldTable</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">CacheEntry</span> <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
					<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">sizeMask</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
						<span class="n">newTable</span><span class="o">[</span><span class="n">idx</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
					<span class="k">else</span> <span class="o">{</span>
						<span class="n">CacheEntry</span> <span class="n">lastRun</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
						<span class="kt">int</span> <span class="n">lastIdx</span> <span class="o">=</span> <span class="n">idx</span><span class="o">;</span>
						<span class="k">for</span> <span class="o">(</span><span class="n">CacheEntry</span> <span class="n">last</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span> <span class="n">last</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
							<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">sizeMask</span><span class="o">;</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="n">lastIdx</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">lastIdx</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
								<span class="n">lastRun</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
							<span class="o">}</span>
						<span class="o">}</span>
						<span class="n">newTable</span><span class="o">[</span><span class="n">lastIdx</span><span class="o">]</span> <span class="o">=</span> <span class="n">lastRun</span><span class="o">;</span>

						<span class="c1">// Clone all remaining nodes</span>
						<span class="k">for</span> <span class="o">(</span><span class="n">CacheEntry</span> <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">lastRun</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
							<span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">sizeMask</span><span class="o">;</span>
							<span class="n">CacheEntry</span> <span class="n">n</span> <span class="o">=</span> <span class="n">newTable</span><span class="o">[</span><span class="n">k</span><span class="o">];</span>
							<span class="n">newTable</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheEntry</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">n</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">livetime</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="n">table</span> <span class="o">=</span> <span class="n">newTable</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">lock</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">remove</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
				<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">t</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">unlock</span><span class="o">();</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * Remove; match on key only if value null, else match both.
		 */</span>
		<span class="n">Object</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// try {</span>
			<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
			<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
			<span class="n">CacheEntry</span> <span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
			<span class="n">CacheEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">!=</span> <span class="n">hash</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)))</span>
				<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>

			<span class="n">Object</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">Object</span> <span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">oldValue</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
					<span class="c1">// All entries following removed node can stay</span>
					<span class="c1">// in list, but all preceding ones need to be</span>
					<span class="c1">// cloned.</span>
					<span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
					<span class="n">CacheEntry</span> <span class="n">newFirst</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
					<span class="k">for</span> <span class="o">(</span><span class="n">CacheEntry</span> <span class="n">p</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">e</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
						<span class="n">newFirst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheEntry</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">newFirst</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">livetime</span><span class="o">);</span>
					<span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">newFirst</span><span class="o">;</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// write-volatile</span>
				<span class="o">}</span>
			<span class="o">}</span>
			<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="n">count</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kd">public</span> <span class="kt">int</span> <span class="nf">getCacheArrayLength</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">table</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 线程开启清除过期缓存
		 */</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">startClearCache</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">startClearCacheTimer</span><span class="o">();</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 清除缓存，如果blockName为null,则表示清除过期缓存，否则清除key中包含blockname的缓存
		 * @param blockName
		 */</span>
		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">startClearCacheWithBlockName</span><span class="o">(</span><span class="n">String</span> <span class="n">blockName</span><span class="o">)</span> <span class="o">{</span>
			<span class="cm">/**
			 * 设置清除缓存开关
			 */</span>
			<span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">head</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">KeyLinked</span> <span class="n">k</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
					<span class="n">KeyLinked</span> <span class="n">prv</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
					<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">total</span><span class="o">++;</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">total</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">prv</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
							<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
							<span class="k">continue</span><span class="o">;</span>
						<span class="o">}</span>
						<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
						<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
						<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
						<span class="n">CacheEntry</span> <span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
						<span class="n">CacheEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
						<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">!=</span> <span class="n">hash</span> <span class="o">||</span> <span class="o">!</span><span class="n">k</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)))</span>
							<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">maxcache</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">String</span><span class="o">[]</span> <span class="n">blockNames</span> <span class="o">=</span> <span class="n">blockName</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\|"</span><span class="o">);</span>
							<span class="kt">boolean</span> <span class="n">find</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
							<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">bn</span> <span class="o">:</span> <span class="n">blockNames</span><span class="o">)</span> <span class="o">{</span>
								<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">bn</span> <span class="o">+</span> <span class="s">"."</span><span class="o">))</span> <span class="o">{</span>
									<span class="k">continue</span><span class="o">;</span>
								<span class="o">}</span>
								<span class="n">find</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
							<span class="o">}</span>
							<span class="k">if</span> <span class="o">(!</span><span class="n">find</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">prv</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
								<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
								<span class="k">continue</span><span class="o">;</span>
							<span class="o">}</span>
						<span class="o">}</span>
						<span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
						<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
						<span class="n">CacheEntry</span> <span class="n">newFirst</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
						<span class="k">for</span> <span class="o">(</span><span class="n">CacheEntry</span> <span class="n">p</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">e</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
							<span class="n">newFirst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CacheEntry</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span> <span class="n">newFirst</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">value</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">livetime</span><span class="o">);</span>
						<span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">newFirst</span><span class="o">;</span>
						<span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// write-volatile</span>
						<span class="cm">/**
						 * 从链表中移除
						 */</span>
						<span class="n">KeyLinked</span> <span class="n">next</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
						<span class="n">k</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
						<span class="n">prv</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
						<span class="n">k</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">te</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">te</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">startClearCacheTimer</span><span class="o">()</span> <span class="o">{</span>
			<span class="cm">/**
			 * 设置清除缓存开关
			 */</span>
			<span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">head</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="n">KeyLinked</span> <span class="n">newHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="n">KeyLinked</span> <span class="n">newcurent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
					<span class="n">CacheEntry</span> <span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
					<span class="n">CacheEntry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
						<span class="k">continue</span><span class="o">;</span>
					<span class="n">CacheEntry</span> <span class="n">cleanCache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">total</span><span class="o">++;</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">livetime</span> <span class="o">&lt;</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">cleanCache</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">cleanCache</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
						<span class="o">}</span>
						<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">cleanCache</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">maxcache</span><span class="o">)</span> <span class="o">{</span>
						<span class="cm">/**
						 * 创建链表
						 */</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">newHead</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
							<span class="n">newHead</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyLinked</span><span class="o">();</span>
							<span class="n">newHead</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
							<span class="n">newcurent</span> <span class="o">=</span> <span class="n">newHead</span><span class="o">;</span>
						<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
							<span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
							<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">KeyLinked</span> <span class="n">k</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyLinked</span><span class="o">();</span>
								<span class="n">k</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
								<span class="n">newcurent</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
								<span class="n">newcurent</span> <span class="o">=</span> <span class="n">k</span><span class="o">;</span>
								<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
							<span class="o">}</span>
						<span class="o">}</span>
						<span class="k">continue</span><span class="o">;</span>
					<span class="o">}</span>
					<span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
					<span class="kt">int</span> <span class="n">temcout</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
					<span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">temcout</span><span class="o">++;</span>
						<span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
					<span class="o">}</span>

					<span class="n">modCount</span> <span class="o">+=</span> <span class="n">temcout</span><span class="o">;</span>
					<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">temcout</span><span class="o">;</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
					<span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">this</span><span class="o">.</span><span class="na">head</span> <span class="o">=</span> <span class="n">newHead</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">current</span> <span class="o">=</span> <span class="n">newcurent</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">te</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">te</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="cm">/**
		 * 删除所有缓存
		 */</span>
		<span class="kd">private</span> <span class="kt">void</span> <span class="nf">clearAllCache</span><span class="o">()</span> <span class="o">{</span>
			<span class="cm">/**
			 * 设置清除缓存开关
			 */</span>
			<span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">CacheEntry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">tab</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">head</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="k">this</span><span class="o">.</span><span class="na">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="n">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
				<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
					<span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">te</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">te</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="n">startclearcache</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">CacheImpl</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">(</span><span class="n">DEFAULT_INITIAL_CAPACITY</span><span class="o">,</span> <span class="n">DEFAULT_LOAD_FACTOR</span><span class="o">,</span> <span class="n">DEFAULT_CONCURRENCY_LEVEL</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nf">CacheImpl</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">concurrencyLevel</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(!(</span><span class="n">loadFactor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">||</span> <span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">concurrencyLevel</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">concurrencyLevel</span> <span class="o">&gt;</span> <span class="n">MAX_SEGMENTS</span><span class="o">)</span>
			<span class="n">concurrencyLevel</span> <span class="o">=</span> <span class="n">MAX_SEGMENTS</span><span class="o">;</span>

		<span class="c1">// Find power-of-two sizes best matching arguments</span>
		<span class="kt">int</span> <span class="n">sshift</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">ssize</span> <span class="o">&lt;</span> <span class="n">concurrencyLevel</span><span class="o">)</span> <span class="o">{</span>
			<span class="o">++</span><span class="n">sshift</span><span class="o">;</span>
			<span class="n">ssize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">segmentShift</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">sshift</span><span class="o">;</span>
		<span class="n">segmentMask</span> <span class="o">=</span> <span class="n">ssize</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">caches</span> <span class="o">=</span> <span class="n">Cache</span><span class="o">.</span><span class="na">newArray</span><span class="o">(</span><span class="n">ssize</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span>
			<span class="n">initialCapacity</span> <span class="o">=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">initialCapacity</span> <span class="o">/</span> <span class="n">ssize</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">ssize</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span><span class="o">)</span>
			<span class="o">++</span><span class="n">c</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">cap</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">)</span>
			<span class="n">cap</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
			<span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cache</span><span class="o">(</span><span class="n">cap</span><span class="o">,</span> <span class="n">loadFactor</span><span class="o">,</span> <span class="n">MAXCACHESIZE</span> <span class="o">/</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
		<span class="cm">/**
		 * 启动清除缓存线程
		 */</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">startclear</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">clearCacheThread</span> <span class="o">=</span> <span class="n">clearCacheThread</span><span class="o">();</span>
			<span class="n">clearCacheThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 是否开始清除缓存
	 */</span>
	<span class="kd">private</span> <span class="kd">volatile</span> <span class="n">Boolean</span> <span class="n">startclear</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="cm">/**
	 * 最后一次清除缓存时间
	 */</span>
	<span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">lastclearTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
	<span class="cm">/**
	 * 清除缓存时间间隔
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">LOAD_TIME_SPAN</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="o">;</span>
	<span class="cm">/**
	 * 停止清除缓存标示
	 */</span>
	<span class="kd">private</span> <span class="kd">volatile</span> <span class="n">Boolean</span> <span class="n">closeThread</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="cm">/**
	 * 清除缓存线程
	 */</span>
	<span class="kd">private</span> <span class="kd">transient</span> <span class="n">Thread</span> <span class="n">clearCacheThread</span><span class="o">;</span>

	<span class="cm">/**
	 * 删除过期缓存线程
	 * @return
	 */</span>
	<span class="kd">private</span> <span class="n">Thread</span> <span class="nf">clearCacheThread</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">startclear</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="n">startclear</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
				<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">closeThread</span><span class="o">)</span>
						<span class="k">return</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastclearTime</span> <span class="o">&lt;</span> <span class="n">LOAD_TIME_SPAN</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">try</span> <span class="o">{</span>
							<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">LOAD_TIME_SPAN</span><span class="o">);</span>
						<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
							<span class="c1">// TODO Auto-generated catch block</span>
							<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
						<span class="o">}</span>
					<span class="o">}</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start clear cache"</span><span class="o">);</span>
					<span class="n">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
						<span class="n">cache</span> <span class="o">=</span> <span class="n">caches</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
						<span class="n">cache</span><span class="o">.</span><span class="na">startClearCache</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"end clear cache"</span><span class="o">);</span>
					<span class="n">lastclearTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">LOAD_TIME_SPAN</span><span class="o">);</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// TODO Auto-generated catch block</span>
						<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
						<span class="k">break</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 添加缓存
	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">putCache</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span> <span class="n">String</span> <span class="n">elmkey</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">times</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="n">cacheName</span><span class="o">,</span> <span class="n">elmkey</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">Cache</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cacheFor</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"key:"</span> <span class="o">+</span> <span class="n">elmkey</span> <span class="o">+</span> <span class="s">" not find cache"</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">c</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">times</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">PutAndUpdateCache</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span> <span class="n">String</span> <span class="n">elmkey</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">,</span> <span class="kt">long</span> <span class="n">times</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">putCache</span><span class="o">(</span><span class="n">cacheName</span><span class="o">,</span> <span class="n">elmkey</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">times</span><span class="o">);</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取缓存key
	 * @param cacheName
	 * @param elmkey
	 * @return
	 */</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">getKey</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span> <span class="n">String</span> <span class="n">elmkey</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cacheName</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">elmkey</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取缓存
	 */</span>
	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheName</span><span class="o">,</span> <span class="n">String</span> <span class="n">elmkey</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">getKey</span><span class="o">(</span><span class="n">cacheName</span><span class="o">,</span> <span class="n">elmkey</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">Cache</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cacheFor</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"key:"</span> <span class="o">+</span> <span class="n">elmkey</span> <span class="o">+</span> <span class="s">" not find cache"</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">c</span><span class="o">.</span><span class="na">setGetSuccesses</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取缓存（已经知道缓存key）
	 *
	 * @param cacheKey
	 * @return
	 */</span>
	<span class="kd">public</span> <span class="n">Object</span> <span class="nf">getValue</span><span class="o">(</span><span class="n">String</span> <span class="n">cacheKey</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">cacheKey</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">Cache</span> <span class="n">c</span> <span class="o">=</span> <span class="n">cacheFor</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"key:"</span> <span class="o">+</span> <span class="n">cacheKey</span> <span class="o">+</span> <span class="s">" not find cache"</span><span class="o">);</span>
			<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">c</span><span class="o">.</span><span class="na">setGetSuccesses</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">value</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 获取缓存中的详细缓存类型及类型的个数
	 */</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="nf">getCacheDetail</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">cacheMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;();</span>
		<span class="kt">long</span> <span class="n">totalput</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="kt">long</span> <span class="n">totalget</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="kt">long</span> <span class="n">totalsuc</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">KeyLinked</span> <span class="n">k</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">head</span><span class="o">;</span>
			<span class="n">totalput</span> <span class="o">+=</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getTotalput</span><span class="o">();</span>
			<span class="n">totalget</span> <span class="o">+=</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getTotalget</span><span class="o">();</span>
			<span class="n">totalsuc</span> <span class="o">+=</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getTotalGetSuccesses</span><span class="o">();</span>
			<span class="k">while</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">k</span><span class="o">.</span><span class="na">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">continue</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">get</span><span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">(</span><span class="n">k</span><span class="o">.</span><span class="na">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">()));</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
					<span class="k">continue</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">isArray</span><span class="o">()</span> <span class="o">||</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Collection</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Map</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">Iterator</span> <span class="n">it</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Collection</span><span class="o">)</span>
						<span class="n">it</span> <span class="o">=</span> <span class="o">((</span><span class="n">Collection</span><span class="o">)</span> <span class="n">o</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>
					<span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="n">Map</span><span class="o">)</span>
						<span class="n">it</span> <span class="o">=</span> <span class="o">((</span><span class="n">Map</span><span class="o">)</span> <span class="n">o</span><span class="o">).</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">it</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
							<span class="n">Object</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
							<span class="k">if</span> <span class="o">(</span><span class="n">cc</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
								<span class="n">className</span> <span class="o">=</span> <span class="n">className</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
							<span class="o">}</span>
						<span class="o">}</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
				<span class="kt">long</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">cacheMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
					<span class="n">count</span> <span class="o">=</span> <span class="n">cacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">className</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
				<span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"cacheCache"</span><span class="o">+</span><span class="n">i</span><span class="o">,</span> <span class="o">(</span><span class="kt">long</span><span class="o">)(</span><span class="k">this</span><span class="o">.</span><span class="na">caches</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">count</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"totalput"</span><span class="o">,</span> <span class="n">totalput</span><span class="o">);</span>
		<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"totalget"</span><span class="o">,</span> <span class="n">totalget</span><span class="o">);</span>
		<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"totalGetSuccesses"</span><span class="o">,</span> <span class="n">totalsuc</span><span class="o">);</span>
		<span class="k">if</span><span class="o">(</span><span class="n">totalsuc</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
			<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"缓存命中率："</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
		<span class="o">}</span><span class="k">else</span> <span class="o">{</span>			
			<span class="n">cacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"缓存命中率（去掉了%）："</span><span class="o">,</span> <span class="n">totalsuc</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">totalget</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">cacheMap</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">Iterator</span> <span class="nf">getIterator</span><span class="o">(</span><span class="n">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Collection</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="o">((</span><span class="n">Collection</span><span class="o">)</span> <span class="n">obj</span><span class="o">).</span><span class="na">iterator</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Map</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span> <span class="o">((</span><span class="n">Map</span><span class="o">)</span> <span class="n">obj</span><span class="o">).</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 清除缓存
	 */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="k">return</span> <span class="nf">cacheFor</span><span class="o">(</span><span class="n">hash</span><span class="o">).</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 清除缓存
	 */</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">block</span><span class="o">,</span> <span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">String</span> <span class="n">cachekey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getKey</span><span class="o">(</span><span class="n">block</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">cachekey</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 清除包含了blockName的缓存 异步清除
	 * @param blockName
	 */</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">removeCacheByBlockName</span><span class="o">(</span><span class="n">String</span> <span class="n">blockName</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="n">String</span> <span class="n">bn</span> <span class="o">=</span> <span class="n">blockName</span><span class="o">;</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start clear blockcache:"</span> <span class="o">+</span> <span class="n">blockName</span><span class="o">);</span>
		<span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">closeThread</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="n">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start clear blockcache："</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
					<span class="n">cache</span> <span class="o">=</span> <span class="n">caches</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
					<span class="n">cache</span><span class="o">.</span><span class="na">startClearCacheWithBlockName</span><span class="o">(</span><span class="n">bn</span><span class="o">);</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"end clear blockcache："</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"end clear blockcache"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stopCache</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">closeThread</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="n">Cache</span> <span class="n">cache</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
				<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start clear blockcache："</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
					<span class="n">cache</span> <span class="o">=</span> <span class="n">caches</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
					<span class="n">cache</span><span class="o">.</span><span class="na">clearAllCache</span><span class="o">();</span>
					<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"end clear blockcache："</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"end clear blockcache"</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}).</span><span class="na">start</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

    </article>
  </div>

  <div class="related">
    <h4>最新文章</h4>
    <ul class="related-posts">
      
        <li>
          <h5>
            <a href="/books/2017/08/18/%E5%86%85%E5%90%91%E8%80%85%E4%BC%98%E5%8A%BF.html">
              内向者优势
              <small>2017-08-18</small>
            </a>
          </h5>
        </li>
      
        <li>
          <h5>
            <a href="/architecture/2017/08/10/%E4%BA%BF%E7%BA%A7%E6%B5%81%E9%87%8F%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF.html">
              亿级流量网站架构核心技术
              <small>2017-08-10</small>
            </a>
          </h5>
        </li>
      
        <li>
          <h5>
            <a href="/architecture/2017/07/26/%E9%87%8D%E6%9E%84%E6%94%B9%E5%96%84%E6%97%A2%E6%9C%89%E4%BB%A3%E7%A0%81%E7%9A%84%E8%AE%BE%E8%AE%A1.html">
              重构-改善既有代码的设计
              <small>2017-07-26</small>
            </a>
          </h5>
        </li>
      
    </ul>
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'michaelygzhangblog';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:g.zhangyg@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/MichaelYgZhang"><i class="svg-icon github"></i></a>




<a href="https://www.twitter.com/michaelygzhang"><i class="svg-icon twitter"></i></a>


<a href="https://plus.google.com/115646538142388831563"><i class="svg-icon googleplus"></i></a>

        </footer>
      </div>
    </div>

    <div id="backToTop" class="backtoTop">
    	<i class="fa fa-hand-o-up fa-2x"></i>
    </div>

    
	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-84531968-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/wheel/2016/12/27/cache.html',
		  'title': 'Cache'
		});
	</script>
	<!-- End Google Analytics -->


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-jekyll-search/1.1.5/jekyll-search.js" type="text/javascript"></script>
    <script src="/js/blog.js" type="text/javascript"></script>

    <script type="text/javascript">
          SimpleJekyllSearch({
            searchInput: document.getElementById('search-input'),
            resultsContainer: document.getElementById('results-container'),
            json: '/search.json',
            searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
            noResultsText: 'No results found',
            limit: 10,
            fuzzy: false,
            exclude: ['Welcome']
          })
    </script>
  </body>
</html>
